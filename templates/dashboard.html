<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Student Applications</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        form { display: flex; flex-direction: column; max-width: 300px; }
        input, select { margin-bottom: 10px; padding: 8px; }
        button { padding: 10px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .delete-btn { background: #dc3545; }
        .delete-btn:hover { background: #c82333; }
        .update-btn { background: #ffc107; color: black; }
        .update-btn:hover { background: #e0a800; }
        #formsList { margin-top: 20px; }
        .form-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .hidden { display: none; }
        #logout { background: #6c757d; }
    </style>
</head>
<body>
    <h1>Dashboard</h1>
    <button id="logout">Logout</button>

    <!-- Apply Form -->
    <div class="section">
        <h2>Submit New Application</h2>
        <form id="applyForm">
            <input type="text" id="full_name" placeholder="Full Name" required>
            <input type="text" id="age" placeholder="Age" required>
            <input type="text" id="course" placeholder="Course" required>
            <button type="submit">Submit Application</button>
        </form>
    </div>

    <!-- Update Form (hidden by default, show when editing) -->
    <div class="section hidden" id="updateSection">
        <h2>Update Application</h2>
        <form id="updateForm">
            <input type="hidden" id="update_form_id">
            <input type="text" id="update_full_name" placeholder="Full Name" required>
            <input type="text" id="update_age" placeholder="Age" required>
            <input type="text" id="update_course" placeholder="Course" required>
            <button type="submit">Update</button>
            <button type="button" id="cancelUpdate">Cancel</button>
        </form>
    </div>

    <!-- Applications List -->
    <div class="section">
        <h2>Your Applications</h2>
        <div id="formsList"></div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
        }

        const headers = { 'Authorization': token, 'Content-Type': 'application/json' };

        // Logout
        document.getElementById('logout').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/';
        });

        // Load applications on page load
        async function loadApplications() {
            try {
                const response = await fetch('/get_apply', { headers });
                const result = await response.json();
                if (response.ok) {
                    displayApplications(result.Form);
                } else {
                    alert(result.error);
                    if (result.error.includes('token')) localStorage.removeItem('token');
                }
            } catch (err) {
                alert('Error loading applications: ' + err.message);
            }
        }

        function displayApplications(forms) {
            const list = document.getElementById('formsList');
            list.innerHTML = forms.map(f => `
                <div class="form-item">
                    <p><strong>Form ID:</strong> ${f.form_id}</p>
                    <p><strong>Full Name:</strong> ${f.fullname}</p>
                    <p><strong>Age:</strong> ${f.age}</p>
                    <p><strong>Course:</strong> ${f.course}</p>
                    <button class="update-btn" onclick="editForm(${f.form_id}, '${f.fullname}', '${f.age}', '${f.course}')">Edit</button>
                    <button class="delete-btn" onclick="deleteForm(${f.form_id})">Delete</button>
                </div>
            `).join('');
        }

        // Submit new application
        document.getElementById('applyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                full_name: document.getElementById('full_name').value,
                age: document.getElementById('age').value,
                course: document.getElementById('course').value
            };
            try {
                const response = await fetch('/apply', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Application submitted');
                    document.getElementById('applyForm').reset();
                    loadApplications();
                } else {
                    alert(result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        // Edit form
        window.editForm = (formId, fullName, age, course) => {
            document.getElementById('update_form_id').value = formId;
            document.getElementById('update_full_name').value = fullName;
            document.getElementById('update_age').value = age;
            document.getElementById('update_course').value = course;
            document.getElementById('updateSection').classList.remove('hidden');
        };

        // Cancel update
        document.getElementById('cancelUpdate').addEventListener('click', () => {
            document.getElementById('updateSection').classList.add('hidden');
            document.getElementById('updateForm').reset();
        });

        // Update application
        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formId = document.getElementById('update_form_id').value;
            const data = {
                full_name: document.getElementById('update_full_name').value,
                age: document.getElementById('update_age').value,
                course: document.getElementById('update_course').value
            };
            try {
                const response = await fetch(`/update_apply/${formId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Application updated');
                    document.getElementById('updateSection').classList.add('hidden');
                    loadApplications();
                } else {
                    alert(result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        // Delete application
        window.deleteForm = async (formId) => {
            if (!confirm('Are you sure you want to delete this application?')) return;
            try {
                const response = await fetch(`/delete_apply/${formId}`, {
                    method: 'DELETE',
                    headers
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Application deleted');
                    loadApplications();
                } else {
                    alert(result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };

        // Initial load
        loadApplications();
    </script>
</body>
</html>